const semver = require("semver");
const vulnerabilityDB = require("../data/vulnerabilityDB");


function findVulnerabilities(packageName, installedVersion){
    if(!packageName || !installedVersion)   return [];
    // if(!records || !installedVersion)  return [];
    
    const name = String(packageName).toLowerCase();
    const records = vulnerabilityDB[name];

    if(!Array.isArray(records)) return [];

    const resolvedVersion = semver.minVersion(installedVersion);
    if (!resolvedVersion)   return [];

    return records.filter(vuln => {
        if(!vuln?.affectedVersions) return false;
        try{
            return semver.satisfies(
                resolvedVersion.version,
                vuln.affectedVersions
            );
        }catch{
            return false;
        }
    });

    // return records.filter(vuln => {
    //     if( !resolvedVersion)   return false;
        
    //     return semver.satisfies
    //     (
    //         resolvedVersion.version,
    //         vuln.affectedVersions
    //     );
    // });
        // cve: vuln.cve,
        // severity: vuln.severity,
        // description: vuln.description,
        // fixedIn: vuln.fixedIn,
        // currentVersion: version
    //     semver.satisfies(resolvedVersion.version, vuln.affectedVersions)
    // );
}


module.exports = {
    findVulnerabilities
};